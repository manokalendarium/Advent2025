<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mama Kalend√°riuma</title>
    
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-gray: #262629;
            --ios-bg: #000000;
            --ios-text: #FFFFFF;
            --ios-gray-text: #8E8E93;
            --glass: rgba(30, 30, 30, 0.6);
            --glass-border: rgba(255, 255, 255, 0.15);
            --royal-gold: #FFD700;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #000; color: white; overflow: hidden; height: 100vh; width: 100vw;
        }

        /* --- H√ÅTT√âR & EFFEKTEK --- */
        .background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at top left, #1a1a2e, #000);
        }
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4;
            animation: float 15s infinite ease-in-out alternate;
        }
        .orb-1 { width: 300px; height: 300px; background: #007AFF; top: -50px; left: -50px; }
        .orb-2 { width: 400px; height: 400px; background: #5E5CE6; bottom: -100px; right: -100px; animation-delay: -5s; }
        
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(40px, 60px); } }

        /* H√ìES√âS */
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.7; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh); } }

        /* --- F≈ê TART√ÅLY --- */
        #app-root { height: 100%; display: flex; justify-content: center; }
        .app-screen {
            width: 100%; max-width: 480px; height: 100%; 
            display: flex; flex-direction: column; position: relative;
            background: rgba(0,0,0,0.2);
            overflow: hidden; /* Fontos, hogy a chat k√©perny≈ë ne l√≥gjon ki */
        }

        /* --- HEADER, GRID, TAB BAR (GRID VIEW) --- */
        .grid-view-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 20px; text-align: center; position: relative; z-index: 10;
        }
        .app-title {
            font-size: 12px; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-bottom: 5px;
        }
        .main-title {
            font-size: 28px; font-weight: 800;
            background: linear-gradient(135deg, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 20px rgba(255,255,255,0.3);
        }
        .countdown {
            font-family: monospace; font-size: 11px; background: rgba(255,255,255,0.1); 
            padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 8px;
            border: 1px solid rgba(255,255,255,0.1); color: var(--royal-gold);
        }
        .grid-container {
            flex: 1; overflow-y: auto; padding: 20px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            align-content: start;
        }
        .grid-container::-webkit-scrollbar { display: none; }
        .day-card {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .day-card:active { transform: scale(0.92); background: rgba(255,255,255,0.15); }
        .day-card.locked { opacity: 0.4; pointer-events: none; background: rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.05); }
        
        .day-num { font-size: 20px; font-weight: 700; }
        .status-icon { font-size: 24px; }
        
        .day-card.opened {
            background: rgba(0, 122, 255, 0.2);
            border-color: rgba(0, 122, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 122, 255, 0.3);
        }
        .tab-bar {
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px 30px 30px 30px;
            display: flex; justify-content: space-around;
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: #888; cursor: pointer; transition: color 0.2s; position: relative;
        }
        .tab-item.active { color: #007AFF; }
        .tab-icon { font-size: 24px; }
        .tab-label { font-size: 10px; font-weight: 500; }
        .badge {
            position: absolute; top: -2px; right: -5px;
            background: #FF3B30; color: white; font-size: 10px; font-weight: bold;
            min-width: 16px; height: 16px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; padding: 2px;
        }

        /* --- MESE MODAL --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 50; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .story-card {
            width: 85%; max-height: 70%; background: #1C1C1E;
            border-radius: 24px; padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column;
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .story-card {
            transform: scale(1);
        }
        .story-title { font-size: 22px; font-weight: 700; margin-bottom: 15px; color: white; text-align: center; }
        .story-text { font-size: 17px; line-height: 1.5; color: #ddd; overflow-y: auto; flex: 1; margin-bottom: 20px; font-family: "Times New Roman", serif; }
        .story-btn {
            background: #007AFF; color: white; border: none; padding: 14px;
            border-radius: 14px; font-size: 17px; font-weight: 600; width: 100%; cursor: pointer;
        }

        /* --- CHAT K√âPERNY≈êK --- */
        .chat-screen-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s ease-out;
        }
        .chat-screen-container.list-active {
            transform: translateX(0);
        }
        .chat-screen-container.detail-active {
            transform: translateX(0);
        }
        /* ... (tov√°bbi chat st√≠lusok) */
        .chat-header {
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px);
            padding: 15px 10px; display: flex; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 20;
        }
        .back-btn { color: #007AFF; font-size: 17px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .chat-avatar-header {
            display: flex; flex-direction: column; align-items: center; flex: 1; margin-right: 40px;
        }
        .header-avatar { font-size: 24px; margin-bottom: 2px; transition: transform 0.2s; cursor: pointer; }
        .header-avatar:active { transform: scale(1.2); }
        .header-name { font-size: 12px; color: #fff; font-weight: 500; }
        .chat-body {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px;
            padding-bottom: 80px;
        }
        .message-row { display: flex; width: 100%; margin-bottom: 4px; }
        .message-row.me { justify-content: flex-end; }
        .message-row.them { justify-content: flex-start; align-items: flex-end; }
        .avatar-small { width: 30px; height: 30px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 8px; }
        .bubble {
            max-width: 75%; padding: 10px 16px; font-size: 17px; line-height: 1.4; position: relative;
        }
        .bubble.me {
            background: #007AFF; color: white; border-radius: 20px 20px 4px 20px;
        }
        .bubble.them {
            background: #262628; color: white; border-radius: 20px 20px 20px 4px;
        }
        .chat-input-bar {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px);
            padding: 10px 15px 30px 15px; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px;
        }
        .ios-input {
            flex: 1; background: #1C1C1E; border: 1px solid #333;
            border-radius: 20px; padding: 8px 15px; color: white; font-size: 17px; outline: none;
        }
        .send-circle {
            width: 30px; height: 30px; background: #007AFF; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; cursor: pointer;
        }
        .send-circle.disabled { background: #444; color: #888; pointer-events: none; }
        .typing-bubble {
            background: #262628; padding: 12px 16px; border-radius: 20px; width: fit-content;
            display: flex; gap: 4px; align-items: center; margin-left: 38px; border-bottom-left-radius: 4px;
        }
        .dot { width: 6px; height: 6px; background: #8E8E93; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .reply-chips { display: flex; gap: 8px; padding: 10px 15px; overflow-x: auto; background: rgba(20, 20, 20, 0.9); border-top: 1px solid rgba(255,255,255,0.1); }
        .chip { background: #1C1C1E; color: #007AFF; border: 1px solid #007AFF; padding: 8px 16px; border-radius: 20px; font-size: 15px; white-space: nowrap; cursor: pointer; }
        
        /* --- iOS NOTIFICATION --- */
        .notification-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200;
        }
        .ios-notification {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(25px);
            border-radius: 18px; padding: 12px;
            display: flex; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            pointer-events: auto; cursor: pointer;
            animation: notifSlide 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .notif-icon {
            width: 40px; height: 40px; background: #333; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 22px;
        }
        .notif-content { flex: 1; }
        .notif-header { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .notif-title { font-weight: 600; font-size: 14px; color: white; }
        .notif-msg { font-size: 14px; color: #fff; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        @keyframes notifSlide { from { transform: translateY(-100px); } to { transform: translateY(0); } }
        
        .test-btn { position: absolute; top: 20px; left: 20px; font-size: 24px; opacity: 0.3; cursor: pointer; z-index: 10; }
        
    </style>
</head>
<body>
    <div id="app-root">
        <div class="app-screen">
            <div class="background">
                <div class="orb orb-1"></div>
                <div class="orb orb-2"></div>
            </div>
            <div id="api-modal" class="api-modal" style="display:none;">
                <div class="api-card">
                    <div style="font-size:40px">üîë</div>
                    <h2>Szia!</h2>
                    <p>K√©rlek add meg a Gemini API kulcsodat, hogy a pl√ºss√∂k tudjanak besz√©lni!</p>
                    <input id="api-input" class="api-input" placeholder="M√°sold ide a kulcsot..." type="text" />
                    <button id="api-save-btn" class="story-btn">Ment√©s √©s Ind√≠t√°s</button>
                </div>
            </div>
            
            <div id="test-btn" class="test-btn">‚öôÔ∏è</div>

            <div id="notification-container" class="notification-container">
                </div>

            <div id="grid-view" class="grid-view-container">
                <div class="header">
                    <div class="app-title">MAMA KALEND√ÅRIUMA</div>
                    <div class="main-title">2025</div>
                    <div id="countdown" class="countdown"></div>
                </div>
                <div id="grid-container" class="grid-container">
                    </div>
                <div class="tab-bar">
                    <div id="tab-grid" class="tab-item active"><i class="bi bi-grid-fill tab-icon"></i><span class="tab-label">Napt√°r</span></div>
                    <div id="tab-chat" class="tab-item"><div style="position:relative"><i class="bi bi-chat-fill tab-icon"></i><div id="unread-badge" class="badge" style="display:none;"></div></div><span class="tab-label">√úzenetek</span></div>
                </div>
            </div>

            <div id="story-modal" class="modal-overlay">
                <div class="story-card">
                    <div id="story-title" class="story-title"></div>
                    <div id="story-text" class="story-text"></div>
                    <button id="story-chat-btn" class="story-btn">Megn√©zem az √ºzenetet</button>
                </div>
            </div>

            <div id="chat-screen-list" class="chat-screen-container">
                <div class="chat-header" style="justify-content:center; position:relative;">
                    <div style="font-weight:bold; font-size:17;">√úzenetek</div>
                    <div id="chat-list-close-btn" style="position:absolute; left:15px; color:#007AFF; cursor:pointer;">Bez√°r√°s</div>
                </div>
                <div id="chat-list-body" class="chat-body" style="padding:0; padding-top:10px;">
                    </div>
            </div>

            <div id="chat-screen-detail" class="chat-screen-container" style="display:none;">
                <div class="chat-header">
                    <div id="chat-detail-back-btn" class="back-btn"><i class="bi bi-chevron-left"></i> Vissza</div>
                    <div id="chat-detail-avatar-header" class="chat-avatar-header">
                        <div id="chat-detail-icon" class="header-avatar"></div>
                        <div id="chat-detail-name" class="header-name"></div>
                    </div>
                    <div style="width:50px;"></div>
                </div>
                <div id="chat-detail-body" class="chat-body">
                    <div style="text-align:center; color:#666; font-size:11px; margin:10px 0;">iMessage ‚Ä¢ Ma</div>
                    </div>
                <div id="reply-chips" class="reply-chips" style="display:none;">
                    </div>
                <div class="chat-input-bar">
                    <input id="chat-input" class="ios-input" placeholder="iMessage" type="text" />
                    <div id="chat-send-circle" class="send-circle disabled"><i class="bi bi-arrow-up"></i></div>
                </div>
            </div>

        </div>
    </div>
    
    <script>
        // --- √ÅLLAND√ìK √âS ADATOK ---
        const ELEMENTS = {
            gridContainer: document.getElementById('grid-container'),
            gridView: document.getElementById('grid-view'),
            storyModal: document.getElementById('story-modal'),
            storyTitle: document.getElementById('story-title'),
            storyText: document.getElementById('story-text'),
            storyChatBtn: document.getElementById('story-chat-btn'),
            countdown: document.getElementById('countdown'),
            unreadBadge: document.getElementById('unread-badge'),
            tabGrid: document.getElementById('tab-grid'),
            tabChat: document.getElementById('tab-chat'),
            apiModal: document.getElementById('api-modal'),
            apiInput: document.getElementById('api-input'),
            apiSaveBtn: document.getElementById('api-save-btn'),
            notificationContainer: document.getElementById('notification-container'),
            chatScreenList: document.getElementById('chat-screen-list'),
            chatScreenDetail: document.getElementById('chat-screen-detail'),
            chatListBody: document.getElementById('chat-list-body'),
            chatDetailBody: document.getElementById('chat-detail-body'),
            chatInput: document.getElementById('chat-input'),
            chatSendCircle: document.getElementById('chat-send-circle'),
            replyChips: document.getElementById('reply-chips'),
            chatDetailIcon: document.getElementById('chat-detail-icon'),
            chatDetailName: document.getElementById('chat-detail-name'),
            testBtn: document.getElementById('test-btn'),
        };

        const CHARACTERS = {
            hanna: { name: "Hanna", icon: "üéÄ", desc: "r√≥zsasz√≠n, gondoskod√≥ l√°ny v√≠zil√≥", style: "Kedves, any√°skod√≥, sok emojit haszn√°l." },
            herold: { name: "Herold", icon: "ü¶õ", desc: "lila, puf√≥k √©s fal√°nk v√≠zil√≥", style: "Vicces, √©hes, szeleburdi." },
            bucko: { name: "Buck√≥", icon: "üê≥", desc: "k√©k, b√°tor kis b√°lna", style: "B√°tor, lelkes, vizet emleget." }
        };

        const STORY_DATA = [
            { id: 1, title: "A nagy elutaz√°s", message: "A reggel k√∂d√∂sen indult... Papa √©s Mama elindultak. Herold coc√≥ az ablakban √°llt. 'Ne itasd az egereket!' ‚Äì mondta Hanna. Buck√≥ t√©sztasz≈±r≈ëvel a fej√©n tisztelgett.", char: "hanna", msgs: ["Szia Mama! ‚ù§Ô∏è Ne agg√≥dj √©rt√ºnk, nagyon √ºgyesek vagyunk itt otthon! Herold m√°r nem is s√≠r. Vigy√°zz magadra! Puszilunk!", "K√©sz√≠tettem neked egy kis csomagot az √∫tra. Haszn√°ld ezt a Mini k√©zkr√©met, hogy puha maradjon a kezed!"], replies: [{u: "K√∂sz√∂n√∂m, Hanna! ‚ù§Ô∏è", c: "Sz√≠vesen! Most megyek, seg√≠tek Heroldnak kipakolni. Szia! üëã"}, {u: "Ti is vigy√°zzatok!", c: "√çg√©rj√ºk! Na szaladok, mert Buck√≥ beszorult. Szia!"}] },
            { id: 2, title: "Els≈ë este", message: "Furcsa csend. Buck√≥ a k√°dban aludt, mert hi√°nyzott neki a tenger. A t√∂bbiek a sz≈ënyegen kempingeztek. 'Ha bet√∂r≈ë j√∂n, csapkodni fogok!'", char: "bucko", msgs: ["Jelentem: a h√°z biztons√°gos! A f√ºrd≈ëk√°dban alszom, onnan mindent hallok. üê≥", "Hogy te is nyugodtan aludj, k√ºld√∂k neked egy kis Levendul√°s p√°rnapermentet. Sz√©p √°lmokat!"], replies: [{u: "J√≥ √©jt, Buck√≥! üåô", c: "Neked is! Megyek csobbanok egyet. Sz√©p √°lmokat! üõÅ"}, {u: "B√°tor vagy!", c: "K√∂szi! De most beb√∫jok a habok al√°. Szia! ü´ß"}] },
        ];
        // Adatok gener√°l√°sa 24 napra (a 3. napt√≥l)
        for(let i=3; i<=24; i++) {
            STORY_DATA.push({ id: i, title: `${i}. Nap`, message: "A t√∂rt√©net hamarosan √©rkezik...", char: "herold", msgs: ["Szia Mama! M√©g k√©sz√ºl√ºnk!", "Itt egy kis szeretet csomag neked!"], replies: [{u: "K√∂szi!", c: "Puszi!"}] });
        }

        // --- √ÅLLAPOTOK (GLOBALS) ---
        let state = {
            apiKey: localStorage.getItem('geminiKey') || "",
            unlockedDays: JSON.parse(localStorage.getItem('openedDays') || '[]'),
            chatHistory: JSON.parse(localStorage.getItem('chatHistory3') || '{}'),
            currentDayId: null,
            view: 'grid', // 'grid', 'story', 'chatList', 'chatDetail'
            typing: false,
            testMode: false,
            notifAfterCloseDayId: null, // √öj: Ez t√°rolja a nap ID-t, amit bez√°r√°s ut√°n √©rtes√≠t√ºnk
        };

        // --- SEG√âDF√úGGV√âNYEK ---

        /** Adatok ment√©se a localStorage-ba */
        function saveState(key, value) {
            if (key === 'unlockedDays') {
                localStorage.setItem('openedDays', JSON.stringify(value));
                state.unlockedDays = value;
            } else if (key === 'chatHistory') {
                localStorage.setItem('chatHistory3', JSON.stringify(value));
                state.chatHistory = value;
            } else if (key === 'apiKey') {
                localStorage.setItem('geminiKey', value);
                state.apiKey = value;
            }
            renderApp(); // Mindig renderelj√ºk √∫jra az √°llapotv√°ltoz√°s ut√°n
        }

        /** √ârtes√≠t√©s hozz√°ad√°sa */
        function addNotification(name, msg, icon) {
            const id = Date.now();
            
            const notifEl = document.createElement('div');
            notifEl.className = 'ios-notification';
            notifEl.innerHTML = `
                <div class="notif-icon">${icon}</div>
                <div class="notif-content">
                    <div class="notif-header"><span class="notif-title">${name}</span><span class="notif-time">Most</span></div>
                    <div class="notif-msg">${msg}</div>
                </div>
            `;
            
            notifEl.onclick = () => {
                setView('chatList');
                notifEl.remove();
            };

            ELEMENTS.notificationContainer.appendChild(notifEl);

            // Elt√°vol√≠t√°s 5 m√°sodperc m√∫lva
            setTimeout(() => {
                notifEl.remove();
            }, 5000);
        }

        /** N√©zet v√°lt√°sa (DOM manipul√°ci√≥) */
        function setView(newView, dayId = null) {
            if (state.view === 'story' && newView === 'grid' && state.notifAfterCloseDayId !== null) {
                // K√©sleltetett √©rtes√≠t√©s megjelen√≠t√©se
                const day = STORY_DATA.find(d => d.id === state.notifAfterCloseDayId);
                if (day) {
                    const char = CHARACTERS[day.char];
                    addNotification(char.name, day.msgs[0], char.icon);
                    setTimeout(() => addNotification(char.name, day.msgs[1], "üéÅ"), 3000);
                }
                state.notifAfterCloseDayId = null;
            }
            
            state.view = newView;
            state.currentDayId = dayId;
            renderApp();
        }
        
        // --- GEMINI API H√çV√ÅS ---
        async function callGemini(userMessage, characterKey, context) {
            const char = CHARACTERS[characterKey];
            const systemPrompt = `You are ${char.name}, a ${char.desc}. You are texting your owner 'Mama'. Style: ${char.style}. Context: ${context}. Reply to: "${userMessage}". Keep it short (max 2 sentences), cute, funny. End with a goodbye reason. Language: Hungarian.`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${state.apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: systemPrompt }] }],
                generationConfig: { temperature: 0.7 }
            };

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if(!response.ok || !data.candidates || data.candidates.length === 0) {
                    throw new Error(data.error?.message || "API Error: No response candidate");
                }
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                // Vissza√°ll√≠t√°s offline √ºzenetre hiba eset√©n
                return "Most tele a sz√°m bejglivel, de egyet√©rtek! ü•Ø (Offline m√≥d)";
            }
        }

        // --- ESEM√âNYKEZEL≈êK ---

        /** Nap megnyit√°sa */
        function handleDayClick(day) {
            const today = new Date().getDate();
            const isAvailable = state.testMode || day.id <= today;
            
            if (isAvailable) {
                if (!state.unlockedDays.includes(day.id)) {
                    // √öj nap megnyit√°sa
                    const newUnlocked = [...state.unlockedDays, day.id];
                    saveState('unlockedDays', newUnlocked);
                    
                    // Kezdeti √ºzenetek l√©trehoz√°sa
                    const initialMsgs = day.msgs.map(m => ({ text: m, isMe: false }));
                    const newHist = { ...state.chatHistory, [day.id]: { msgs: initialMsgs, seen: false } };
                    saveState('chatHistory', newHist);
                    
                    // Be√°ll√≠tjuk, hogy ezt a napot √©rtes√≠teni kell bez√°r√°s ut√°n
                    state.notifAfterCloseDayId = day.id;
                }
                
                // Mese Modal megjelen√≠t√©se
                ELEMENTS.storyTitle.textContent = 'üìú ' + day.title;
                ELEMENTS.storyText.textContent = day.message;
                setView('story', day.id);
            } else {
                addNotification("Rendszer", "M√©g nem szabad! ü§´", "üîí");
            }
        }
        
        /** √úzenet k√ºld√©se (AI v√°lasz logik√°val) */
        async function sendMessage(text) {
            if (!text.trim() || state.typing || !state.currentDayId) return;

            const dayId = state.currentDayId;
            const day = STORY_DATA.find(d => d.id === dayId);
            let currentHist = state.chatHistory[dayId] || { msgs: [] };

            // 1. √úzenet hozz√°ad√°sa a historibe (k√ºld≈ë: √©n)
            const newMsgs = [...currentHist.msgs, { text, isMe: true }];
            saveState('chatHistory', { ...state.chatHistory, [dayId]: { ...currentHist, msgs: newMsgs, seen: true } });
            ELEMENTS.chatInput.value = "";
            
            // 2. Typing √°llapot be√°ll√≠t√°sa √©s UI friss√≠t√©s
            state.typing = true;
            renderChatDetail();
            
            // 3. AI h√≠v√°s (k√©sleltetve)
            await new Promise(r => setTimeout(r, 2000));
            const context = `Mese: ${day.message}. Aj√°nd√©k: ${day.msgs[1]}`;
            const response = await callGemini(text, day.char, context);
            
            // 4. Typing √°llapot kikapcsol√°sa
            state.typing = false;
            
            // 5. AI v√°lasz hozz√°ad√°sa (k√ºld≈ë: pl√ºss)
            const finalMsgs = [...newMsgs, { text: response, isMe: false }];
            const finalHist = { ...state.chatHistory, [dayId]: { msgs: finalMsgs, seen: true } };
            saveState('chatHistory', finalHist); // Ment√©s √©s Render
        }

        // --- RENDER F√úGGV√âNYEK ---

        /** L√©trehoz egy h√≥pih√©t, be√°ll√≠tja a v√©letlenszer≈± st√≠lusokat */
        function createSnowflake() {
            const snowflakeEl = document.createElement('div');
            snowflakeEl.className = 'snowflake';
            snowflakeEl.style.left = Math.random() * 100 + '%';
            snowflakeEl.style.animationDuration = (Math.random() * 5 + 3) + 's';
            snowflakeEl.style.width = Math.random() * 4 + 2 + 'px';
            snowflakeEl.style.height = Math.random() * 4 + 2 + 'px';
            snowflakeEl.style.animationDelay = Math.random() * 5 + 's';
            document.querySelector('.app-screen').appendChild(snowflakeEl);
            setTimeout(() => snowflakeEl.remove(), (Math.random() * 5 + 8) * 1000); // 8-13 m√°sodperc ut√°n elt√°vol√≠tja
        }

        /** Kijelzi a visszasz√°ml√°l√≥t */
        function updateCountdown() {
            const target = new Date("Dec 24, 2025 18:00:00").getTime();
            const diff = target - new Date().getTime();
            if (diff > 0) {
                const d = Math.floor(diff / (86400000));
                ELEMENTS.countdown.textContent = `M√©g ${d} nap kar√°csonyig`;
            } else {
                ELEMENTS.countdown.textContent = "BOLDOG KAR√ÅCSONYT!";
                clearInterval(countdownInterval);
            }
        }
        
        /** Kirajzolja a Napt√°r k√°rty√°kat */
        function renderGrid() {
            ELEMENTS.gridContainer.innerHTML = ''; // T√∂rli az el≈ëz≈ë tartalmat
            STORY_DATA.forEach(day => {
                const isOpen = state.unlockedDays.includes(day.id);
                const isLocked = day.id > new Date().getDate() && !isOpen && !state.testMode;
                
                const cardEl = document.createElement('div');
                cardEl.className = `day-card ${isOpen ? 'opened' : ''} ${isLocked ? 'locked' : ''}`;
                cardEl.onclick = () => handleDayClick(day);
                
                cardEl.innerHTML = isOpen 
                    ? `<div class="status-icon">üéÅ</div>` 
                    : `<div class="day-num">${day.id}</div>`;
                
                if (isLocked) {
                    cardEl.innerHTML += `<div style="position:absolute; bottom:5px; font-size:10px;">üîí</div>`;
                }
                
                ELEMENTS.gridContainer.appendChild(cardEl);
            });
        }
        
        /** Kirajzolja a Chat List√°t */
        function renderChatList() {
            ELEMENTS.chatListBody.innerHTML = '';
            let totalUnread = 0;
            
            // Csak a kinyitott napok jelennek meg a list√°ban
            state.unlockedDays.sort((a,b) => b - a).forEach(id => {
                const day = STORY_DATA.find(d => d.id === id);
                if (!day) return;
                
                const char = CHARACTERS[day.char];
                const hist = state.chatHistory[id] || { msgs: [] };
                const lastMsg = hist.msgs[hist.msgs.length-1]?.text || day.msgs[day.msgs.length-1];
                
                const isUnread = !hist.seen;
                if (isUnread) totalUnread++;

                const listItem = document.createElement('div');
                listItem.onclick = () => setView('chatDetail', id);
                listItem.style.cssText = 'display:flex; gap:15px; padding:15px; border-bottom:1px solid #222; cursor:pointer;';
                
                listItem.innerHTML = `
                    <div style="font-size:30px;">${char.icon}</div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between;"><span style="font-weight:bold; color:${isUnread ? 'white' : '#666'};">${char.name}</span><span style="color:${isUnread ? 'white' : '#666'}; font-size:14px;">Ma</span></div>
                        <div style="color:${isUnread ? 'white' : '#888'}; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:250px; font-weight:${isUnread ? 'bold' : 'normal'};">${lastMsg}</div>
                    </div>
                    ${isUnread ? '<div style="width:10px; height:10px; border-radius:50%; background:#007AFF; align-self:center;"></div>' : ''}
                `;
                ELEMENTS.chatListBody.appendChild(listItem);
            });
            
            // Jelv√©ny friss√≠t√©se
            ELEMENTS.unreadBadge.textContent = totalUnread;
            ELEMENTS.unreadBadge.style.display = totalUnread > 0 ? 'flex' : 'none';
        }

        /** Kirajzolja a Chat Detailt */
        function renderChatDetail() {
            const dayId = state.currentDayId;
            if (!dayId) return;

            const day = STORY_DATA.find(d => d.id === dayId);
            if (!day) return;

            const char = CHARACTERS[day.char];
            const hist = state.chatHistory[dayId] || { msgs: [] };
            
            // Fejl√©c friss√≠t√©se
            ELEMENTS.chatDetailIcon.textContent = char.icon;
            ELEMENTS.chatDetailName.textContent = char.name;

            // √úzenetek kirajzol√°sa
            ELEMENTS.chatDetailBody.innerHTML = '<div style="text-align:center; color:#666; font-size:11px; margin:10px 0;">iMessage ‚Ä¢ Ma</div>';
            
            hist.msgs.forEach(msg => {
                const msgRow = document.createElement('div');
                msgRow.className = `message-row ${msg.isMe ? 'me' : 'them'}`;
                
                const avatarHtml = !msg.isMe ? `<div class="avatar-small">${char.icon}</div>` : '';
                const bubbleHtml = `<div class="bubble ${msg.isMe ? 'me' : 'them'}">${msg.text}</div>`;
                
                msgRow.innerHTML = msg.isMe ? bubbleHtml : avatarHtml + bubbleHtml;
                ELEMENTS.chatDetailBody.appendChild(msgRow);
            });

            // Typing Indicator
            const typingEl = document.querySelector('.typing-bubble');
            if (state.typing && !typingEl) {
                const typingRow = document.createElement('div');
                typingRow.className = 'message-row them';
                typingRow.innerHTML = `
                    <div class="avatar-small">${char.icon}</div>
                    <div class="typing-bubble">
                        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    </div>`;
                ELEMENTS.chatDetailBody.appendChild(typingRow);
            } else if (!state.typing && typingEl) {
                typingEl.parentNode.remove();
            }

            // Scroll az alj√°ra
            ELEMENTS.chatDetailBody.scrollTop = ELEMENTS.chatDetailBody.scrollHeight;
            
            // Gyorsv√°lasz csipek
            const hasSentMessage = hist.msgs.some(m => m.isMe);
            if (!hasSentMessage && day.replies && day.replies.length > 0) {
                ELEMENTS.replyChips.style.display = 'flex';
                ELEMENTS.replyChips.innerHTML = '';
                day.replies.forEach(reply => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = reply.u;
                    chip.onclick = () => sendMessage(reply.u);
                    ELEMENTS.replyChips.appendChild(chip);
                });
            } else {
                ELEMENTS.replyChips.style.display = 'none';
            }

            // Megjel√∂l√©s olvasottk√©nt
            if (!hist.seen) {
                saveState('chatHistory', { ...state.chatHistory, [dayId]: { ...hist, seen: true } });
            }
        }
        
        /** A f≈ë renderel≈ë f√ºggv√©ny */
        function renderApp() {
            // F≈ë n√©zetv√°lt√°s
            ELEMENTS.gridView.style.display = state.view === 'grid' ? 'flex' : 'none';
            ELEMENTS.storyModal.classList.toggle('active', state.view === 'story');
            ELEMENTS.chatScreenList.classList.toggle('list-active', state.view === 'chatList');
            ELEMENTS.chatScreenDetail.style.display = state.view === 'chatDetail' ? 'flex' : 'none';
            
            // Tab akt√≠v √°llapot
            ELEMENTS.tabGrid.classList.toggle('active', state.view === 'grid');
            ELEMENTS.tabChat.classList.toggle('active', state.view === 'chatList' || state.view === 'chatDetail');

            // API Modal ellen≈ërz√©s
            ELEMENTS.apiModal.style.display = state.apiKey ? 'none' : 'flex';
            if (!state.apiKey) return;
            
            // K√©perny≈ë specifikus renderel√©s
            if (state.view === 'grid') {
                renderGrid();
                renderChatList(); // Friss√≠ti a badge-et
            } else if (state.view === 'chatList') {
                renderChatList();
            } else if (state.view === 'chatDetail') {
                renderChatList();
                renderChatDetail();
            }
        }

        // --- INICIALIZ√ÅCI√ì √âS ESEM√âNY BE√ÅLL√çT√ÅSOK ---
        
        // H√≥es√©s
        for(let i=0; i<40; i++) {
            createSnowflake();
        }

        // Id≈ëz√≠t≈ëk
        updateCountdown();
        const countdownInterval = setInterval(updateCountdown, 1000);

        // API gomb esem√©ny
        ELEMENTS.apiSaveBtn.onclick = () => {
            const key = ELEMENTS.apiInput.value.trim();
            if(key.length > 10) {
                saveState('apiKey', key);
                ELEMENTS.apiModal.style.display = 'none';
                renderApp();
            } else {
                alert("√ârv√©nytelen kulcs!");
            }
        };

        // Tab gombok
        ELEMENTS.tabGrid.onclick = () => setView('grid');
        ELEMENTS.tabChat.onclick = () => setView('chatList');
        
        // Modal gombok
        ELEMENTS.storyModal.onclick = (e) => {
            if (e.target.id === 'story-modal') {
                setView('grid');
            }
        };
        ELEMENTS.storyChatBtn.onclick = () => {
            // Bez√°r√°s (k√©sleltetett √©rtes√≠t√©s kiv√°lt√°sa)
            setView('grid'); 
            // V√°lt√°s chatre kis k√©sleltet√©ssel az anim√°ci√≥ miatt
            setTimeout(() => setView('chatDetail', state.currentDayId), 300);
        };
        
        // Chat detail navig√°ci√≥
        document.getElementById('chat-list-close-btn').onclick = () => setView('grid');
        document.getElementById('chat-detail-back-btn').onclick = () => setView('chatList');
        
        // Chat bevitel/k√ºld√©s
        ELEMENTS.chatInput.oninput = () => {
            const hasText = ELEMENTS.chatInput.value.trim().length > 0;
            ELEMENTS.chatSendCircle.classList.toggle('disabled', !hasText);
        };
        ELEMENTS.chatSendCircle.onclick = () => {
            sendMessage(ELEMENTS.chatInput.value);
        };
        ELEMENTS.chatInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                sendMessage(ELEMENTS.chatInput.value);
            }
        };
        
        // Simogat√°s (Petting)
        document.getElementById('chat-detail-avatar-header').onclick = () => {
            if (navigator.vibrate) navigator.vibrate(50);
            const day = STORY_DATA.find(d => d.id === state.currentDayId);
            if (day) addNotification(CHARACTERS[day.char].name, "H√∫, de j√≥lesett! ‚ù§Ô∏è", "ü•∞");
        };

        // Teszt m√≥d
        ELEMENTS.testBtn.onclick = () => {
            state.testMode = !state.testMode;
            addNotification("Rendszer", `Teszt M√≥d: ${state.testMode ? 'BE' : 'KI'}`, "‚öôÔ∏è");
            renderApp();
        }

        // Els≈ë futtat√°s
        window.onload = renderApp;
    </script>
</body>
</html>
