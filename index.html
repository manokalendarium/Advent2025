<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="format-detection" content="telephone=no">
    
    <title>Mama Kalend√°riuma</title>
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-gradient-1: #0f172a;
            --bg-gradient-2: #1e1b4b;
            --accent-gold: #fbbf24;
            --accent-blue: #60a5fa;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --anim-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
        
        body { 
            margin: 0; font-family: 'DM Sans', sans-serif; background: #000; color: white; 
            overflow: hidden; height: 100vh; width: 100vw;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            touch-action: none; /* Megakad√°lyozza a rug√≥z√°st a teljes oldalon */
        }

        /* --- H√ÅTT√âR --- */
        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 0% 0%, var(--bg-gradient-2), var(--bg-gradient-1)); }
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; animation: float 15s infinite alternate; }
        .orb-1 { width: 300px; height: 300px; background: #007AFF; top: -50px; left: -50px; }
        .orb-2 { width: 400px; height: 400px; background: #5E5CE6; bottom: -100px; right: -100px; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 50px); } }
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.5; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.5s ease-out;
        }
        .splash-logo { font-size: 60px; animation: pulseLogo 1.5s infinite; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* --- APP LAYOUT --- */
        .app-screen {
            width: 100%; max-width: 500px; height: 100%; margin: 0 auto;
            display: flex; flex-direction: column; position: relative;
        }

        /* --- HEADER --- */
        .header { padding: 20px; padding-top: 10px; text-align: left; }
        .app-title { font-size: 12px; letter-spacing: 2px; text-transform: uppercase; color: #94a3b8; font-weight: 700; }
        .main-title { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .countdown { font-family: monospace; background: rgba(251,191,36,0.15); color: var(--accent-gold); padding: 4px 10px; border-radius: 12px; font-size: 12px; display: inline-block; margin-top: 5px; border: 1px solid rgba(251,191,36,0.3); }

        /* --- GRID --- */
        .grid-container {
            flex: 1; overflow-y: auto; padding: 10px 20px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            align-content: start; padding-bottom: 100px;
            -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
        }
        .grid-container::-webkit-scrollbar { display: none; }

        .day-card {
            aspect-ratio: 1; background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .day-card:active { transform: scale(0.9); }
        .day-card.locked { opacity: 0.4; background: rgba(0,0,0,0.2); }
        .day-card.opened { background: rgba(96, 165, 250, 0.2); border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 15px rgba(96, 165, 250, 0.3); }
        .day-num { font-size: 18px; font-weight: 700; }
        .status-icon { font-size: 22px; }

        /* --- TAB BAR --- */
        .tab-bar-container { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; pointer-events: none; z-index: 50; }
        .tab-bar {
            pointer-events: auto; background: rgba(30, 30, 40, 0.85); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); padding: 10px 30px; border-radius: 50px;
            display: flex; gap: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .tab-item { font-size: 24px; color: #64748b; transition: all 0.2s; position: relative; }
        .tab-item.active { color: var(--accent-blue); transform: translateY(-2px); }
        .badge { position: absolute; top: -2px; right: -5px; background: #ef4444; width: 10px; height: 10px; border-radius: 50%; }

        /* --- MODAL (SWIPEABLE SHEET) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 100;
            display: flex; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .story-card {
            width: 100%; height: 90%; background: #1c1c1e;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            padding: 0 24px 30px 24px;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
        }
        .modal-overlay.active .story-card { transform: translateY(0); }
        
        /* DRAG HANDLE */
        .drag-handle-area { width: 100%; padding: 15px 0; display: flex; justify-content: center; cursor: grab; touch-action: none; }
        .drag-handle { width: 40px; height: 5px; background: #444; border-radius: 3px; }

        .story-title { font-size: 22px; font-weight: 700; text-align: center; margin-bottom: 15px; }
        .story-text { 
            font-size: 17px; line-height: 1.6; color: #e2e8f0; overflow-y: auto; flex: 1; 
            text-align: justify; padding-bottom: 20px; -webkit-overflow-scrolling: touch;
        }
        .story-text p { margin-bottom: 1em; }
        
        .story-btn {
            background: var(--accent-blue); color: #000; border: none; padding: 16px;
            border-radius: 18px; font-size: 16px; font-weight: 700; width: 100%;
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
        }
        .story-btn:active { transform: scale(0.96); }

        .story-nav-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .dot-indicator { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: all 0.3s; }
        .dot-indicator.active { background: var(--accent-blue); width: 24px; border-radius: 4px; }

        /* --- CHAT UI --- */
        .chat-screen-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200;
            display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease-out;
        }
        .chat-screen-container.active { transform: translateX(0); }
        
        .chat-header { padding: 15px 15px 15px 15px; background: rgba(20, 20, 30, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; }
        .chat-title { font-weight: 700; font-size: 17px; }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        
        .chat-list-item { display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid #222; transition: background 0.2s; }
        .chat-list-item:active { background: #111; }
        
        .message-row { display: flex; margin-bottom: 8px; opacity: 0; animation: slideUp 0.3s forwards; }
        .message-row.me { justify-content: flex-end; }
        .bubble { padding: 10px 16px; border-radius: 18px; font-size: 16px; max-width: 75%; line-height: 1.4; }
        .bubble.me { background: var(--accent-blue); color: #000; }
        .bubble.them { background: #27272a; color: white; }
        .bubble.image-bubble { padding: 0; background: transparent; overflow: hidden; }
        .bubble.image-bubble img { width: 100%; border-radius: 12px; display: block; }

        .chat-input-bar { padding: 10px 15px 40px 15px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; align-items: center; }
        .ios-input { flex: 1; background: #222; border: none; border-radius: 20px; padding: 10px 15px; color: white; font-size: 16px; outline: none; }
        .send-circle { width: 35px; height: 35px; background: var(--accent-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; }
        .send-circle:active { transform: scale(0.9); }

        /* --- PARTICLES (Confetti & Dust) --- */
        .magic-particle { position: fixed; width: 4px; height: 4px; background: white; border-radius: 50%; pointer-events: none; z-index: 9999; animation: fadeOut 1s forwards; }
        .confetti { position: fixed; width: 8px; height: 8px; position: absolute; animation: fallConfetti linear forwards; z-index: 9999; }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }
        @keyframes fallConfetti { to { transform: translateY(100vh) rotate(720deg); } }

        /* --- NOTIFICATION --- */
        .ios-notification { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(50, 50, 60, 0.95); backdrop-filter: blur(10px); padding: 12px; border-radius: 16px; display: flex; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: notifSlide 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 500; border: 1px solid rgba(255,255,255,0.1); }
        .notif-icon { font-size: 24px; }
        .notif-title { font-weight: 700; font-size: 14px; }
        .notif-msg { font-size: 14px; color: #ccc; }

        /* API MODAL */
        .api-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .api-card { width: 85%; background: #1c1c1e; padding: 30px; border-radius: 24px; text-align: center; border: 1px solid #333; }

    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-logo">üéÅ</div>
        <h2 style="color:white; font-weight:700; margin-top:20px;">Mama Kalend√°riuma</h2>
    </div>

    <div id="app-root" style="display:none;"> <div class="app-screen">
            <div class="background">
                <div class="orb orb-1"></div>
                <div class="orb orb-2"></div>
            </div>
            
            <div id="api-modal" class="api-modal" style="display:none;">
                <div class="api-card">
                    <div style="font-size:40px">üîë</div>
                    <h2>Szia!</h2>
                    <p>K√©rlek add meg a Gemini API kulcsodat!</p>
                    <input id="api-input" class="api-input" placeholder="Kulcs helye..." type="text" />
                    <button id="api-save-btn" class="story-btn" style="margin-top:15px;">Ind√≠t√°s</button>
                </div>
            </div>

            <div id="notification-container" class="notification-container"></div>

            <div id="grid-view" class="grid-view-container">
                <div class="header">
                    <div class="app-title">MAMA KALEND√ÅRIUMA</div>
                    <div class="main-title">2025</div>
                    <div id="countdown" class="countdown">...</div>
                </div>
                <div id="grid-container" class="grid-container"></div>
                <div class="tab-bar-container">
                    <div class="tab-bar">
                        <div id="tab-grid" class="tab-item active"><i class="bi bi-grid-fill"></i></div>
                        <div id="tab-chat" class="tab-item"><i class="bi bi-chat-fill"></i><div id="unread-badge" class="badge" style="display:none;"></div></div>
                    </div>
                </div>
            </div>

            <div id="story-modal" class="modal-overlay">
                <div class="story-card" id="story-card-content">
                    <div class="drag-handle-area" id="drag-handle">
                        <div class="drag-handle"></div>
                    </div>
                    <div id="story-title" class="story-title"></div>
                    
                    <div style="flex:1; overflow:hidden; position:relative;">
                        <div id="story-page-1" class="story-text" style="height:100%;"></div>
                        <div id="story-page-2" class="story-text" style="display:none; height:100%;"></div>
                    </div>

                    <div class="story-nav-dots">
                        <span id="dot-1" class="dot-indicator active"></span>
                        <span id="dot-2" class="dot-indicator"></span>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button id="story-prev-btn" class="story-btn" style="background:#333; display:none;">Vissza</button>
                        <button id="story-next-btn" class="story-btn">Tov√°bb</button>
                        <button id="story-close-btn" class="story-btn" style="background:#333; display:none;">Bez√°r√°s</button>
                    </div>
                </div>
            </div>

            <div id="chat-screen-list" class="chat-screen-container">
                <div class="chat-header">
                    <div class="chat-title">√úzenetek</div>
                    <div id="chat-list-close-btn" style="color:#007AFF; font-weight:600;">K√©sz</div>
                </div>
                <div id="chat-list-body" class="chat-body"></div>
            </div>

            <div id="chat-screen-detail" class="chat-screen-container">
                <div class="chat-header">
                    <div id="chat-detail-back-btn" class="back-btn"><i class="bi bi-chevron-left"></i> Vissza</div>
                    <div style="text-align:center;">
                        <div id="chat-detail-icon" style="font-size:24px;"></div>
                        <div id="chat-detail-name" style="font-size:12px;"></div>
                    </div>
                    <div style="width:50px;"></div>
                </div>
                <div id="chat-detail-body" class="chat-body"></div>
                <div id="reply-chips" class="reply-chips" style="display:none;"></div>
                <div class="chat-input-bar">
                    <input id="chat-input" class="ios-input" placeholder="iMessage" type="text" />
                    <div id="chat-send-circle" class="send-circle"><i class="bi bi-arrow-up"></i></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- HANGOK √âS REZG√âS (Base64 placeholders - val√≥s appban cser√©lni kellene, de itt a playTone-t haszn√°lom) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        function haptic(type) {
            if (navigator.vibrate) navigator.vibrate(type === 'heavy' ? 50 : 10);
        }
        function playSound(type) {
            if (type === 'pop') playTone(600, 'sine', 0.1);
            if (type === 'ding') playTone(1200, 'sine', 0.3);
            if (type === 'paper') playTone(200, 'triangle', 0.15);
        }

        // --- MAGIC DUST & KONFETTI ---
        document.addEventListener('touchmove', (e) => {
            if(Math.random() > 0.8) {
                const d = document.createElement('div'); d.className = 'magic-particle';
                d.style.left = e.touches[0].clientX + 'px'; d.style.top = e.touches[0].clientY + 'px';
                document.body.appendChild(d); setTimeout(()=>d.remove(), 1000);
            }
        });
        function triggerConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'];
            for(let i=0; i<40; i++) {
                const c = document.createElement('div'); c.className = 'confetti';
                c.style.left = Math.random()*100+'vw'; c.style.top = '-10px';
                c.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                c.style.animationDuration = (Math.random()*2+2)+'s';
                document.body.appendChild(c); setTimeout(()=>c.remove(), 4000);
            }
        }

        // --- ADATOK (A kor√°bbiak alapj√°n) ---
        const CHARACTERS = {
            hanna: { name: "Hanna", icon: "üéÄ", key: "hanna" },
            herold: { name: "Herold", icon: "ü¶õ", key: "herold" },
            bucko: { name: "Buck√≥", icon: "üê≥", key: "bucko" }
        };
        const CHAT_CONTACTS = [ CHARACTERS.hanna, CHARACTERS.herold, CHARACTERS.bucko ];
        
        // Teljes lista bem√°solva az el≈ëz≈ë v√°laszb√≥l (r√∂vid√≠tve a hely miatt, de a logika itt van)
        const STORY_DATA = [
            { id: 1, char: "hanna", title: "A nagy elutaz√°s", storyPage1: "A reggel k√∂d√∂sen indult...", storyPage2: "Ekkor megjelent Buck√≥...", storyImageText: "N√©zd, √©pp most k√©sz√≠tettem egy k√©pet!", storyImageUrl: "placeholder_day1.jpg", msgs: ["Szia Mama! ‚ù§Ô∏è Ne agg√≥dj...", "K√©sz√≠tettem neked egy kis csomagot..."], replies: [] },
             // ... Itt j√∂nne a t√∂bbi 23 nap adata ...
             { id: 2, char: "bucko", title: "Az els≈ë este", storyPage1: "Csend volt...", storyPage2: "Buck√≥ a k√°dban...", storyImageText: "K√©p a k√°dr√≥l!", storyImageUrl: "placeholder.jpg", msgs: ["Jelentem...", "F√ºrd≈ëbomba!"], replies: [] }
        ];
        
        // Adatp√≥tl√°s a dem√≥ m≈±k√∂d√©s√©hez
        for(let i=1; i<=24; i++) {
            if(!STORY_DATA.find(d=>d.id===i)) {
                const c = i%3===0?"hanna":(i%3===1?"herold":"bucko");
                STORY_DATA.push({id:i, char:c, title:`${i}. Nap`, storyPage1:"Mese 1...", storyPage2:"Mese 2...", storyImageText:"K√©p...", storyImageUrl:"", msgs:[`Szia!`, `Aj√°nd√©k!`], replies:[]});
            }
        }

        // --- STATE ---
        let state = {
            apiKey: localStorage.getItem('geminiKey') || "",
            unlockedDays: JSON.parse(localStorage.getItem('openedDays') || '[]'),
            chatHistory: JSON.parse(localStorage.getItem('chatHistory3') || '{}'),
            currentDayId: null, view: 'grid', typing: false, notifAfterCloseDayId: null, storyPage: 1
        };

        const ELEMENTS = {
            gridContainer: document.getElementById('grid-container'),
            gridView: document.getElementById('grid-view'),
            storyModal: document.getElementById('story-modal'),
            storyCard: document.getElementById('story-card-content'),
            storyTitle: document.getElementById('story-title'),
            storyPage1: document.getElementById('story-page-1'), storyPage2: document.getElementById('story-page-2'),
            storyPrevBtn: document.getElementById('story-prev-btn'), storyNextBtn: document.getElementById('story-next-btn'), storyCloseBtn: document.getElementById('story-close-btn'),
            storyDot1: document.getElementById('dot-1'), storyDot2: document.getElementById('dot-2'),
            chatScreenList: document.getElementById('chat-screen-list'),
            chatScreenDetail: document.getElementById('chat-screen-detail'),
            chatListBody: document.getElementById('chat-list-body'),
            chatDetailBody: document.getElementById('chat-detail-body'),
            chatInput: document.getElementById('chat-input'),
            notificationContainer: document.getElementById('notification-container'),
            apiModal: document.getElementById('api-modal'),
            unreadBadge: document.getElementById('unread-badge'),
            tabGrid: document.getElementById('tab-grid'), tabChat: document.getElementById('tab-chat'),
            dragHandle: document.getElementById('drag-handle')
        };

        // --- LOGIKA ---
        function saveState(k, v) {
            if(k==='unlockedDays') { localStorage.setItem('openedDays', JSON.stringify(v)); state.unlockedDays=v; }
            else if(k==='chatHistory') { localStorage.setItem('chatHistory3', JSON.stringify(v)); state.chatHistory=v; }
            else { localStorage.setItem('geminiKey', v); state.apiKey=v; }
            renderApp();
        }

        function setView(view, id=null) {
            haptic('light');
            
            // Noti logika
            if(state.view === 'story' && view === 'grid' && state.notifAfterCloseDayId) {
                const d = STORY_DATA.find(x=>x.id===state.notifAfterCloseDayId);
                if(d) {
                    const c = CHARACTERS[d.char];
                    setTimeout(()=>addNotif(c.name, d.msgs[0], c.icon), 400);
                    setTimeout(()=>addNotif(c.name, `${c.name} k√©pet k√ºld√∂tt!`, c.icon), 2500);
                    setTimeout(()=>addNotif(c.name, d.msgs[d.msgs.length-1], "üéÅ"), 4500);
                }
                state.notifAfterCloseDayId = null;
            }

            state.view = view;
            if(id) state.currentDayId = id;
            if(view === 'story') state.storyPage = 1;

            // Transitions
            ELEMENTS.apiModal.style.display = state.apiKey ? 'none' : 'flex';
            ELEMENTS.gridView.style.display = view==='grid'?'flex':'none';
            ELEMENTS.storyModal.classList.toggle('active', view==='story');
            
            ELEMENTS.chatScreenList.classList.toggle('active', view==='chatList'||view==='chatDetail');
            if(view === 'chatDetail') {
                ELEMENTS.chatScreenDetail.style.transform = 'translateX(0)';
            } else {
                ELEMENTS.chatScreenDetail.style.transform = 'translateX(100%)';
            }

            // Tab Active
            ELEMENTS.tabGrid.classList.toggle('active', view==='grid');
            ELEMENTS.tabChat.classList.toggle('active', view==='chatList'||view==='chatDetail');

            if(view==='grid') renderGrid();
            if(view==='story') updateStoryPages();
            if(view==='chatList') renderChatList();
            if(view==='chatDetail') { renderChatList(); renderChatDetail(); }
        }

        function addNotif(name, msg, icon) {
            playSound('ding'); haptic('heavy');
            const n = document.createElement('div'); n.className='ios-notification';
            n.innerHTML = `<div class="notif-icon">${icon}</div><div><div class="notif-title">${name}</div><div class="notif-msg">${msg}</div></div>`;
            n.onclick = () => setView('chatList');
            ELEMENTS.notificationContainer.appendChild(n);
            setTimeout(()=>n.remove(), 5000);
        }

        function handleDayClick(day) {
            const today = 31; // Teszt m√≥d
            if (day.id <= today) {
                if(!state.unlockedDays.includes(day.id)) {
                    triggerConfetti(); playSound('pop'); haptic('heavy');
                    const unlocked = [...state.unlockedDays, day.id];
                    saveState('unlockedDays', unlocked);
                    
                    // Init Chat Msg
                    const msgs = [
                        {text: day.msgs[0], isMe:false},
                        {text: day.storyImageText, isMe:false, isImageText:true},
                        {text: `<img src="${day.storyImageUrl}" alt="K√©p">`, isMe:false, isImage:true},
                        {text: day.msgs[day.msgs.length-1], isMe:false}
                    ];
                    saveState('chatHistory', {...state.chatHistory, [day.id]: {msgs, seen:false}});
                    state.notifAfterCloseDayId = day.id;
                }
                ELEMENTS.storyTitle.innerText = day.title;
                setView('story', day.id);
            }
        }

        function updateStoryPages() {
            playSound('paper');
            const d = STORY_DATA.find(x=>x.id===state.currentDayId);
            ELEMENTS.storyPage1.innerHTML = `<p>${d.storyPage1}</p>`;
            ELEMENTS.storyPage2.innerHTML = `<p>${d.storyPage2}</p>`;
            ELEMENTS.storyPage1.style.display = state.storyPage===1?'block':'none';
            ELEMENTS.storyPage2.style.display = state.storyPage===2?'block':'none';
            
            if(state.storyPage===1) {
                ELEMENTS.storyPrevBtn.style.display='none'; ELEMENTS.storyNextBtn.style.display='block'; ELEMENTS.storyCloseBtn.style.display='none';
            } else {
                ELEMENTS.storyPrevBtn.style.display='block'; ELEMENTS.storyNextBtn.style.display='none'; ELEMENTS.storyCloseBtn.style.display='block';
            }
            ELEMENTS.storyDot1.classList.toggle('active', state.storyPage===1);
            ELEMENTS.storyDot2.classList.toggle('active', state.storyPage===2);
        }

        // --- SWIPE LOGIC (STORY MODAL) ---
        let startY = 0; let currentY = 0;
        const card = ELEMENTS.storyCard;
        const handle = ELEMENTS.dragHandle;

        handle.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; });
        handle.addEventListener('touchmove', (e) => {
            currentY = e.touches[0].clientY;
            const diff = currentY - startY;
            if (diff > 0) card.style.transform = `translateY(${diff}px)`; // Drag down
        });
        handle.addEventListener('touchend', () => {
            const diff = currentY - startY;
            if (diff > 150) setView('grid'); // Close
            else card.style.transform = ''; // Reset
        });

        // --- RENDEREREK ---
        function renderGrid() {
            ELEMENTS.gridContainer.innerHTML = '';
            STORY_DATA.forEach(d => {
                const open = state.unlockedDays.includes(d.id);
                const el = document.createElement('div');
                el.className = `day-card ${open?'opened':''} ${d.id>31?'locked':''}`;
                el.innerHTML = open ? `<div class="status-icon">üéÅ</div>` : `<div class="day-num">${d.id}</div>`;
                if(d.id>31) el.classList.add('locked');
                el.onclick = () => handleDayClick(d);
                ELEMENTS.gridContainer.appendChild(el);
            });
        }

        function renderChatList() {
            ELEMENTS.chatListBody.innerHTML = '';
            let unread = 0;
            CHAT_CONTACTS.forEach(c => {
                const charDays = STORY_DATA.filter(d=>d.char===c.key && state.unlockedDays.includes(d.id)).sort((a,b)=>b.id-a.id);
                if(charDays.length===0) return;
                
                let isUnread = false;
                let lastMsg = "Nincs √ºzenet";
                charDays.forEach(d => { if(state.chatHistory[d.id] && !state.chatHistory[d.id].seen) { isUnread=true; unread++; }});
                
                if(state.chatHistory[charDays[0].id]?.msgs.length) {
                    const m = state.chatHistory[charDays[0].id].msgs;
                    const l = m[m.length-1];
                    lastMsg = l.isImage ? "K√©p" : l.text;
                }

                const el = document.createElement('div');
                el.className = 'chat-list-item';
                el.innerHTML = `<div class="avatar-small" style="font-size:24px">${c.icon}</div><div style="flex:1"><div><b>${c.name}</b></div><div style="font-size:14px;color:#888">${lastMsg}</div></div>${isUnread?'<div style="background:#007AFF;width:10px;height:10px;border-radius:50%"></div>':''}`;
                el.onclick = () => setView('chatDetail', charDays[0].id);
                ELEMENTS.chatListBody.appendChild(el);
            });
            ELEMENTS.unreadBadge.textContent = unread;
            ELEMENTS.unreadBadge.style.display = unread>0?'flex':'none';
        }

        function renderChatDetail() {
            if(!state.currentDayId) return;
            const day = STORY_DATA.find(d=>d.id===state.currentDayId);
            const char = CHARACTERS[day.char];
            document.getElementById('chat-detail-icon').innerText = char.icon;
            document.getElementById('chat-detail-name').innerText = char.name;
            
            ELEMENTS.chatDetailBody.innerHTML = '';
            const allDays = STORY_DATA.filter(d=>d.char===day.char && state.unlockedDays.includes(d.id)).sort((a,b)=>a.id-b.id);
            
            let markRead = false;
            allDays.forEach(d => {
                if(state.chatHistory[d.id]) {
                    if(!state.chatHistory[d.id].seen) { state.chatHistory[d.id].seen=true; markRead=true; }
                    ELEMENTS.chatDetailBody.innerHTML+=`<div style="text-align:center;font-size:11px;color:#666;margin:10px">${d.title}</div>`;
                    state.chatHistory[d.id].msgs.forEach(m => {
                        const row = document.createElement('div'); row.className=`message-row ${m.isMe?'me':'them'}`;
                        const content = m.isImage ? `<div class="bubble image-bubble">${m.text}</div>` : `<div class="bubble ${m.isMe?'me':'them'}">${m.text}</div>`;
                        row.innerHTML = m.isMe ? content : `<div class="avatar-small">${char.icon}</div>${content}`;
                        ELEMENTS.chatDetailBody.appendChild(row);
                    });
                }
            });
            if(markRead) saveState('chatHistory', state.chatHistory);
            ELEMENTS.chatDetailBody.scrollTop = ELEMENTS.chatDetailBody.scrollHeight;
        }

        function renderApp() {
            // SPLASH
            setTimeout(() => { document.getElementById('splash-screen').style.opacity=0; setTimeout(()=>document.getElementById('splash-screen').remove(),500); document.getElementById('app-root').style.display='block'; }, 1500);

            if(!state.apiKey) { ELEMENTS.apiModal.style.display='flex'; } else { ELEMENTS.apiModal.style.display='none'; renderGrid(); }
        }

        // Event Listeners
        ELEMENTS.storyNextBtn.onclick = () => { state.storyPage=2; updateStoryPages(); };
        ELEMENTS.storyPrevBtn.onclick = () => { state.storyPage=1; updateStoryPages(); };
        ELEMENTS.storyCloseBtn.onclick = () => setView('grid');
        document.getElementById('api-save-btn').onclick = () => { if(document.getElementById('api-input').value.length>5) saveState('apiKey', document.getElementById('api-input').value); };
        document.getElementById('chat-list-close-btn').onclick = () => setView('grid');
        document.getElementById('chat-detail-back-btn').onclick = () => setView('chatList');
        document.getElementById('tab-grid').onclick = () => setView('grid');
        document.getElementById('tab-chat').onclick = () => setView('chatList');
        
        // Countdown
        setInterval(() => {
            const diff = Math.ceil((new Date(2025,11,24) - new Date())/(1000*60*60*24));
            ELEMENTS.countdown.innerText = `M√©g ${diff} nap`;
        }, 1000);

        // Start
        renderApp();

    </script>
</body>
</html>
