<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Mama Kalend√°riuma</title>

    <link
      href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <style>
      :root {
        --ios-blue: #007aff;
        --ios-gray: #262629;
        --ios-bg: #000000;
        --ios-text: #ffffff;
        --ios-gray-text: #8e8e93;
        --glass: rgba(30, 30, 30, 0.6);
        --glass-border: rgba(255, 255, 255, 0.15);
        --royal-gold: #ffd700;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: #000;
        color: white;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
      }

      /* --- ANIM√ÅCI√ìK --- */
      @keyframes popIn {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes slideUp {
        0% {
          transform: translateY(20px);
          opacity: 0;
        }
        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes shine {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }
      @keyframes float {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(40px, 60px);
        }
      }
      @keyframes notifSlide {
        from {
          transform: translateY(-100px);
        }
        to {
          transform: translateY(0);
        }
      }

      /* Kattint√°s effekt (rug√≥s) */
      .clickable:active {
        transform: scale(0.95);
        transition: transform 0.1s;
      }

      /* --- H√ÅTT√âR & EFFEKTEK --- */
      .background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: radial-gradient(circle at top left, #1a1a2e, #000);
      }
      .orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.4;
        animation: float 15s infinite ease-in-out alternate;
      }
      .orb-1 {
        width: 300px;
        height: 300px;
        background: #007aff;
        top: -50px;
        left: -50px;
      }
      .orb-2 {
        width: 400px;
        height: 400px;
        background: #5e5ce6;
        bottom: -100px;
        right: -100px;
        animation-delay: -5s;
      }

      .snowflake {
        position: absolute;
        background: white;
        border-radius: 50%;
        opacity: 0.7;
        pointer-events: none;
        animation: fall linear infinite;
      }
      @keyframes fall {
        to {
          transform: translateY(105vh);
        }
      }

      /* --- F≈ê TART√ÅLY --- */
      #app-root {
        height: 100%;
        display: flex;
        justify-content: center;
      }
      .app-screen {
        width: 100%;
        max-width: 480px;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
        background: rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      /* --- API KULCS MODAL --- */
      .api-modal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: popIn 0.3s ease-out;
      }
      .api-card {
        width: 85%;
        background: #1c1c1e;
        padding: 30px;
        border-radius: 24px;
        text-align: center;
        border: 1px solid #333;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
      }
      .api-input {
        width: 100%;
        padding: 12px;
        margin: 15px 0;
        background: #2c2c2e;
        border: 1px solid #444;
        border-radius: 12px;
        color: white;
        font-size: 16px;
        outline: none;
      }

      /* --- HEADER, CAROUSEL, TAB BAR --- */
      .grid-view-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .header {
        padding: 20px;
        text-align: center;
        position: relative;
        z-index: 10;
      }
      .app-title {
        font-size: 12px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 5px;
      }
      .main-title {
        font-size: 28px;
        font-weight: 800;
        background: linear-gradient(135deg, #fff, #ccc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
      }
      .countdown {
        font-family: monospace;
        font-size: 11px;
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 8px;
        border-radius: 6px;
        display: inline-block;
        margin-top: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--royal-gold);
      }

      /* --- M√ìDOS√çTOTT CAROUSEL CONTAINER --- */
      .grid-container {
        flex: 1;
        overflow-x: auto;
        overflow-y: hidden;
        /* Padding biztos√≠tja, hogy az els≈ë √©s utols√≥ elem is k√∂z√©pre ker√ºlhessen */
        padding: 0 12.5vw;
        display: flex;
        gap: 20px;
        align-items: center;
        scroll-snap-type: x mandatory; /* Ez a "m√°gneses" bepattan√°s kulcsa */
        scroll-behavior: smooth;
        perspective: 1000px;
      }

      .grid-container::-webkit-scrollbar {
        display: none;
      }

      /* --- M√ìDOS√çTOTT K√ÅRTY√ÅK --- */
      .day-card {
        min-width: 75vw; /* Sz√©les k√°rtya */
        height: 60vh; /* Magas k√°rtya */
        background: rgba(255, 255, 255, 0.08);
        border-radius: 32px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);

        /* Fontos a carousel m≈±k√∂d√©s√©hez: */
        scroll-snap-align: center;
        flex-shrink: 0;
        overflow: hidden;
      }

      .day-card.locked {
        opacity: 0.5;
        transform: scale(0.95);
        filter: grayscale(80%);
        pointer-events: none;
        background: rgba(0, 0, 0, 0.4);
        border-color: rgba(255, 255, 255, 0.05);
      }

      .day-num {
        font-size: 90px; /* √ìri√°si sz√°m */
        font-weight: 800;
        background: linear-gradient(to bottom, #fff, #888);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .status-icon {
        font-size: 60px; /* Nagy pipa */
        animation: popIn 0.3s;
      }

      .day-card.opened {
        background: rgba(0, 122, 255, 0.15);
        border-color: rgba(0, 122, 255, 0.5);
        box-shadow: 0 0 30px rgba(0, 122, 255, 0.25);
        transform: scale(1.02);
      }

      /* Csillog√°s effekt */
      .day-card.opened::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(
          to right,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transform: skewX(-25deg);
        animation: shine 4s infinite;
      }

      .tab-bar {
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px 30px 30px 30px;
        display: flex;
        justify-content: space-around;
        z-index: 20;
      }
      .tab-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: #888;
        cursor: pointer;
        transition: color 0.2s;
        position: relative;
      }
      .tab-item.active {
        color: #007aff;
        transform: scale(1.1);
        transition: transform 0.2s;
      }
      .tab-icon {
        font-size: 24px;
      }
      .tab-label {
        font-size: 10px;
        font-weight: 500;
      }
      .badge {
        position: absolute;
        top: -2px;
        right: -5px;
        background: #ff3b30;
        color: white;
        font-size: 10px;
        font-weight: bold;
        min-width: 16px;
        height: 16px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px;
        animation: popIn 0.3s;
      }

      /* --- MESE MODAL --- */
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      .story-card {
        width: 85%;
        max-height: 80%;
        background: #1c1c1e;
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .modal-overlay.active .story-card {
        transform: scale(1);
      }

      .story-title {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 15px;
        color: white;
        text-align: center;
      }
      .story-text {
        font-size: 17px;
        line-height: 1.5;
        color: #ddd;
        overflow-y: auto;
        flex: 1;
        margin-bottom: 5px;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        text-align: justify;
        padding-right: 5px;
        animation: slideUp 0.3s ease-out;
      }
      .story-text p {
        margin: 1em 0;
      }
      .story-btn {
        background: #007aff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 14px;
        font-size: 15px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        transition: all 0.1s;
      }
      .story-btn:active {
        transform: scale(0.95);
      }
      .dot-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #444;
        transition: background 0.3s;
      }
      .dot-indicator.active {
        background: #007aff;
        transform: scale(1.2);
      }

      /* --- CHAT K√âPERNY≈êK --- */
      .chat-screen-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 100;
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .chat-screen-container.active {
        transform: translateX(0);
      }

      .chat-header {
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(20px);
        padding: 15px 10px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 20;
      }
      .back-btn {
        color: #007aff;
        font-size: 17px;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }
      .chat-avatar-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        margin-right: 40px;
      }
      .header-avatar {
        font-size: 24px;
        margin-bottom: 2px;
        transition: transform 0.2s;
        cursor: pointer;
      }
      .header-avatar:active {
        transform: scale(1.2);
      }
      .header-name {
        font-size: 12px;
        color: #fff;
        font-weight: 500;
      }

      .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-bottom: 80px;
        scroll-behavior: smooth;
      }
      .message-row {
        display: flex;
        width: 100%;
        margin-bottom: 4px;
        opacity: 0;
        animation: slideUp 0.3s forwards;
      }
      .message-row.me {
        justify-content: flex-end;
      }
      .message-row.them {
        justify-content: flex-start;
        align-items: flex-end;
      }

      .avatar-small {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        margin-right: 8px;
      }

      /* K√âP √úZENET */
      .bubble.image-bubble {
        background: none;
        padding: 0;
        border-radius: 20px 20px 20px 4px;
        overflow: hidden;
        max-width: 75%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
      .bubble.image-bubble img {
        max-width: 100%;
        display: block;
        border-radius: 12px;
        filter: brightness(0.95);
      }

      .bubble {
        max-width: 75%;
        padding: 10px 16px;
        font-size: 17px;
        line-height: 1.4;
        position: relative;
      }
      .bubble.me {
        background: #007aff;
        color: white;
        border-radius: 20px 20px 4px 20px;
      }
      .bubble.them {
        background: #262628;
        color: white;
        border-radius: 20px 20px 20px 4px;
      }

      .chat-input-bar {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: rgba(20, 20, 20, 0.9);
        backdrop-filter: blur(20px);
        padding: 10px 15px 30px 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .ios-input {
        flex: 1;
        background: #1c1c1e;
        border: 1px solid #333;
        border-radius: 20px;
        padding: 8px 15px;
        color: white;
        font-size: 17px;
        outline: none;
      }
      .send-circle {
        width: 30px;
        height: 30px;
        background: #007aff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .send-circle:active {
        transform: scale(0.9);
      }
      .send-circle.disabled {
        background: #444;
        color: #888;
        pointer-events: none;
      }

      .typing-bubble {
        background: #262628;
        padding: 12px 16px;
        border-radius: 20px;
        width: fit-content;
        display: flex;
        gap: 4px;
        align-items: center;
        margin-left: 38px;
        border-bottom-left-radius: 4px;
        animation: popIn 0.3s;
      }
      .dot {
        width: 6px;
        height: 6px;
        background: #8e8e93;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .reply-chips {
        display: flex;
        gap: 8px;
        padding: 10px 15px;
        overflow-x: auto;
        background: rgba(20, 20, 20, 0.9);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        animation: slideUp 0.3s;
      }
      .chip {
        background: #1c1c1e;
        color: #007aff;
        border: 1px solid #007aff;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 15px;
        white-space: nowrap;
        cursor: pointer;
        transition: background 0.1s;
      }
      .chip:active {
        background: #007aff;
        color: white;
        transform: scale(0.95);
      }

      /* --- iOS NOTIFICATION --- */
      .notification-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 200;
      }
      .ios-notification {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        background: rgba(30, 30, 30, 0.85);
        backdrop-filter: blur(25px);
        border-radius: 18px;
        padding: 12px;
        display: flex;
        gap: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        pointer-events: auto;
        cursor: pointer;
        animation: notifSlide 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .notif-icon {
        width: 40px;
        height: 40px;
        background: #333;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
      }
      .notif-content {
        flex: 1;
      }
      .notif-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2px;
      }
      .notif-title {
        font-weight: 600;
        font-size: 14px;
        color: white;
      }
      .notif-msg {
        font-size: 14px;
        color: #fff;
        line-height: 1.2;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .test-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 24px;
        opacity: 0.3;
        cursor: pointer;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div id="app-root">
      <div class="app-screen">
        <div class="background">
          <div class="orb orb-1"></div>
          <div class="orb orb-2"></div>
        </div>

        <div id="api-modal" class="api-modal" style="display: none">
          <div class="api-card">
            <div style="font-size: 40px">üîë</div>
            <h2>Szia!</h2>
            <p>
              K√©rlek add meg a Gemini API kulcsodat, hogy a pl√ºss√∂k tudjanak
              besz√©lni!
            </p>
            <input
              id="api-input"
              class="api-input"
              placeholder="M√°sold ide a kulcsot..."
              type="text"
            />
            <button id="api-save-btn" class="story-btn clickable">
              Ment√©s √©s Ind√≠t√°s
            </button>
          </div>
        </div>

        <div id="test-btn" class="test-btn">‚öôÔ∏è</div>

        <div id="notification-container" class="notification-container"></div>

        <div id="grid-view" class="grid-view-container">
          <div class="header">
            <div class="app-title">MAMA KALEND√ÅRIUMA</div>
            <div class="main-title">2025</div>
            <div id="countdown" class="countdown"></div>
          </div>
          <div id="grid-container" class="grid-container"></div>
          <div class="tab-bar">
            <div id="tab-grid" class="tab-item active clickable">
              <i class="bi bi-grid-fill tab-icon"></i
              ><span class="tab-label">Napt√°r</span>
            </div>
            <div id="tab-chat" class="tab-item clickable">
              <div style="position: relative">
                <i class="bi bi-chat-fill tab-icon"></i>
                <div
                  id="unread-badge"
                  class="badge"
                  style="display: none"
                ></div>
              </div>
              <span class="tab-label">√úzenetek</span>
            </div>
          </div>
        </div>

        <div id="story-modal" class="modal-overlay">
          <div class="story-card">
            <div id="story-title" class="story-title"></div>
            <div id="story-page-1" class="story-text story-page"></div>
            <div
              id="story-page-2"
              class="story-text story-page"
              style="display: none"
            ></div>

            <div
              id="story-nav"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 10px;
              "
            >
              <button
                id="story-prev-btn"
                class="story-btn clickable"
                style="
                  width: 45%;
                  background: rgba(255, 255, 255, 0.1);
                  color: #fff;
                "
              >
                <i class="bi bi-chevron-left"></i> El≈ëz≈ë
              </button>
              <div id="story-dots" style="display: flex; gap: 8px">
                <span id="dot-1" class="dot-indicator active"></span>
                <span id="dot-2" class="dot-indicator"></span>
              </div>
              <button
                id="story-next-btn"
                class="story-btn clickable"
                style="width: 45%"
              >
                <i class="bi bi-chevron-right"></i> K√∂vetkez≈ë
              </button>
            </div>
            <button
              id="story-close-btn"
              class="story-btn clickable"
              style="margin-top: 15px"
            >
              Bez√°r√°s
            </button>
          </div>
        </div>

        <div id="chat-screen-list" class="chat-screen-container">
          <div
            class="chat-header"
            style="justify-content: center; position: relative"
          >
            <div style="font-weight: bold; font-size: 17">√úzenetek</div>
            <div
              id="chat-list-close-btn"
              class="clickable"
              style="
                position: absolute;
                left: 15px;
                color: #007aff;
                cursor: pointer;
              "
            >
              Bez√°r√°s
            </div>
          </div>
          <div
            id="chat-list-body"
            class="chat-body"
            style="padding: 0; padding-top: 10px"
          ></div>
        </div>

        <div id="chat-screen-detail" class="chat-screen-container">
          <div class="chat-header">
            <div id="chat-detail-back-btn" class="back-btn clickable">
              <i class="bi bi-chevron-left"></i> Vissza
            </div>
            <div
              id="chat-detail-avatar-header"
              class="chat-avatar-header clickable"
            >
              <div id="chat-detail-icon" class="header-avatar"></div>
              <div id="chat-detail-name" class="header-name"></div>
            </div>
            <div style="width: 50px"></div>
          </div>
          <div id="chat-detail-body" class="chat-body"></div>
          <div id="reply-chips" class="reply-chips" style="display: none"></div>
          <div class="chat-input-bar">
            <input
              id="chat-input"
              class="ios-input"
              placeholder="iMessage"
              type="text"
            />
            <div id="chat-send-circle" class="send-circle disabled clickable">
              <i class="bi bi-arrow-up"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- HANGOK (Base64) ---
      const SOUNDS = {
        pop: new Audio(
          "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."
        ),
        ding: new Audio(
          "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."
        ),
        paper: new Audio(
          "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."
        ),
      };

      // Egyszer≈± hanggener√°l√°s JS-b≈ël
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playTone(freq, type, duration) {
        if (audioCtx.state === "suspended") audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(
          0.001,
          audioCtx.currentTime + duration
        );
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
      }

      function playSound(type) {
        if (type === "pop") playTone(600, "sine", 0.1);
        if (type === "ding") playTone(1200, "sine", 0.3);
        if (type === "paper") playTone(200, "triangle", 0.15);
      }

      // --- √ÅLLAND√ìK √âS ADATOK ---
      const ELEMENTS = {
        gridContainer: document.getElementById("grid-container"),
        gridView: document.getElementById("grid-view"),
        storyModal: document.getElementById("story-modal"),
        storyTitle: document.getElementById("story-title"),
        storyPage1: document.getElementById("story-page-1"),
        storyPage2: document.getElementById("story-page-2"),
        storyPrevBtn: document.getElementById("story-prev-btn"),
        storyNextBtn: document.getElementById("story-next-btn"),
        storyDot1: document.getElementById("dot-1"),
        storyDot2: document.getElementById("dot-2"),
        storyCloseBtn: document.getElementById("story-close-btn"),
        countdown: document.getElementById("countdown"),
        unreadBadge: document.getElementById("unread-badge"),
        tabGrid: document.getElementById("tab-grid"),
        tabChat: document.getElementById("tab-chat"),
        apiModal: document.getElementById("api-modal"),
        apiInput: document.getElementById("api-input"),
        apiSaveBtn: document.getElementById("api-save-btn"),
        notificationContainer: document.getElementById(
          "notification-container"
        ),
        chatScreenList: document.getElementById("chat-screen-list"),
        chatScreenDetail: document.getElementById("chat-screen-detail"),
        chatListBody: document.getElementById("chat-list-body"),
        chatDetailBody: document.getElementById("chat-detail-body"),
        chatInput: document.getElementById("chat-input"),
        chatSendCircle: document.getElementById("chat-send-circle"),
        replyChips: document.getElementById("reply-chips"),
        chatDetailIcon: document.getElementById("chat-detail-icon"),
        chatDetailName: document.getElementById("chat-detail-name"),
        testBtn: document.getElementById("test-btn"),
      };

      const CHARACTERS = {
        hanna: {
          name: "Hanna",
          icon: "üéÄ",
          desc: "r√≥zsasz√≠n, gondoskod√≥ l√°ny v√≠zil√≥",
          style: "Kedves, any√°skod√≥, sok emojit haszn√°l.",
          key: "hanna",
        },
        herold: {
          name: "Herold",
          icon: "ü¶õ",
          desc: "lila, puf√≥k √©s fal√°nk v√≠zil√≥",
          style: "Vicces, √©hes, szeleburdi.",
          key: "herold",
        },
        bucko: {
          name: "Buck√≥",
          icon: "üê≥",
          desc: "k√©k, b√°tor kis b√°lna",
          style: "B√°tor, lelkes, vizet emleget.",
          key: "bucko",
        },
      };

      const CHAT_CONTACTS = [
        CHARACTERS.hanna,
        CHARACTERS.herold,
        CHARACTERS.bucko,
      ];

      const STORY_DATA = [
        // 1. HANNA
        {
          id: 1,
          char: "hanna",
          title: "A nagy elutaz√°s",
          storyPage1:
            "A reggel k√∂d√∂sen indult, a leveg≈ëben m√°r √©rezni lehetett a t√©l illat√°t. Papa √©s Mama √≥ri√°si b≈ër√∂nd√∂ket cipeltek ki az aut√≥hoz. Herold coc√≥ az ablakban √°llt, √©s az orr√°t az √ºveghez nyomta, amit≈ël az egy kicsit lapos √©s vicces lett. Egy apr√≥ k√∂nnycsepp csillogott a szem√©ben. ‚Äì Ne szomorkodj, Herold! ‚Äì l√©pett oda hozz√° Hanna coc√≥, √©s b√°tran √°t√∂lelte testv√©r√©t. ‚Äì Mienk az eg√©sz h√°z, azt csin√°lunk, amit akarunk!",
          storyPage2:
            "Ekkor megjelent Buck√≥, a kis b√°lna, fej√©n egy ford√≠tott t√©sztasz≈±r≈ëvel, ami √∫gy n√©zett ki, mint egy sisak. ‚Äì Jelentem, a b√°zis v√©delm√©t √°tvettem! ‚Äì harsogta m√©ly hangj√°n. ‚Äì Senki nem l√©phet be enged√©ly n√©lk√ºl, csak a post√°s, ha hoz csomagot! Papa √©s Mama meg√≠g√©rt√©k: kar√°csonyra, mire az els≈ë csillag felj√∂n, itthon lesznek.",
          storyImageText:
            "N√©zd, √©pp most k√©sz√≠tettem egy k√©pet, ahogy integet√ºnk!",
          storyImageUrl: "placeholder_day1.jpg",
          msgs: [
            "Szia Mama! ‚ù§Ô∏è Ne agg√≥dj √©rt√ºnk, nagyon √ºgyesek vagyunk itt otthon! Herold m√°r nem is s√≠r. Vigy√°zz magadra! Puszilunk!",
            "K√©sz√≠tettem neked egy kis csomagot az √∫tra. Haszn√°ld ezt a Mini k√©zkr√©met, hogy puha maradjon a kezed!",
          ],
          replies: [
            {
              u: "K√∂sz√∂n√∂m, Hanna! ‚ù§Ô∏è",
              c: "Sz√≠vesen! Most megyek, seg√≠tek Heroldnak kipakolni. Szia! üëã",
            },
            { u: "Ti is vigy√°zzatok!", c: "√çg√©rj√ºk! Na szaladok! Szia!" },
          ],
        },
      ];

      // P√ìTL√ÅS A DEM√ìHOZ (hogy a k√≥d futtathat√≥ legyen teljes adat n√©lk√ºl is)
      for (let i = 2; i <= 24; i++) {
        if (!STORY_DATA.find((d) => d.id === i)) {
          const dummyChar =
            i % 3 === 0 ? "hanna" : i % 3 === 1 ? "herold" : "bucko";
          STORY_DATA.push({
            id: i,
            char: dummyChar,
            title: `${i}. Nap`,
            storyPage1: "Mese eleje...",
            storyPage2: "Mese v√©ge...",
            storyImageText: "K√©p...",
            storyImageUrl: "",
            msgs: ["Szia!", "Aj√°nd√©k!"],
            replies: [],
          });
        }
      }

      // --- √ÅLLAPOTOK ---
      let state = {
        apiKey: localStorage.getItem("geminiKey") || "",
        unlockedDays: JSON.parse(localStorage.getItem("openedDays") || "[]"),
        chatHistory: JSON.parse(localStorage.getItem("chatHistory3") || "{}"),
        currentDayId: null,
        view: "grid",
        typing: false,
        testMode: false,
        notifAfterCloseDayId: null,
        storyPage: 1,
      };

      // --- FUNKCI√ìK ---

      function saveState(key, value) {
        if (key === "unlockedDays") {
          localStorage.setItem("openedDays", JSON.stringify(value));
          state.unlockedDays = value;
        } else if (key === "chatHistory") {
          localStorage.setItem("chatHistory3", JSON.stringify(value));
          state.chatHistory = value;
        } else if (key === "apiKey") {
          localStorage.setItem("geminiKey", value);
          state.apiKey = value;
        }
        renderApp();
      }

      function addNotification(name, msg, icon) {
        playSound("ding");
        const notifEl = document.createElement("div");
        notifEl.className = "ios-notification";
        notifEl.innerHTML = `
                <div class="notif-icon">${icon}</div>
                <div class="notif-content">
                    <div class="notif-header"><span class="notif-title">${name}</span><span class="notif-time">Most</span></div>
                    <div class="notif-msg">${msg}</div>
                </div>
            `;

        notifEl.onclick = () => {
          setView("chatList");
          notifEl.remove();
        };

        ELEMENTS.notificationContainer.appendChild(notifEl);
        setTimeout(() => notifEl.remove(), 5000);
      }

      function setView(newView, dayId = null) {
        // NOTIFIK√ÅCI√ìK LOGIK√ÅJA
        if (
          state.view === "story" &&
          newView === "grid" &&
          state.notifAfterCloseDayId !== null
        ) {
          const day = STORY_DATA.find(
            (d) => d.id === state.notifAfterCloseDayId
          );
          if (day) {
            const char = CHARACTERS[day.char];

            // 1. Reakci√≥
            setTimeout(() => {
              addNotification(char.name, day.msgs[0], char.icon);
            }, 400);

            // 2. K√©p √©rtes√≠t√©s
            const imageNotifText = `${char.name} k√©pet k√ºld√∂tt!`;
            setTimeout(() => {
              addNotification(char.name, imageNotifText, char.icon);
            }, 2500);

            // 3. Aj√°nd√©k
            setTimeout(() => {
              addNotification(char.name, day.msgs[day.msgs.length - 1], "üéÅ");
            }, 4500);
          }
          state.notifAfterCloseDayId = null;
        }

        state.view = newView;
        if (dayId !== null) state.currentDayId = dayId;
        if (newView === "story") state.storyPage = 1;

        // Chat k√©perny≈ëk anim√°ci√≥s kezel√©se
        if (newView === "chatList") {
          ELEMENTS.chatScreenList.classList.add("active");
          ELEMENTS.chatScreenDetail.classList.remove("active");
        } else if (newView === "chatDetail") {
          ELEMENTS.chatScreenList.classList.add("active");
          ELEMENTS.chatScreenDetail.classList.add("active");
        } else {
          ELEMENTS.chatScreenList.classList.remove("active");
          ELEMENTS.chatScreenDetail.classList.remove("active");
        }

        renderApp();
      }

      function updateStoryModalPages() {
        playSound("paper");
        const day = STORY_DATA.find((d) => d.id === state.currentDayId);
        if (!day) return;

        ELEMENTS.storyPage1.innerHTML = day.storyPage1
          .split("\n")
          .map((p) => `<p>${p}</p>`)
          .join("");
        ELEMENTS.storyPage2.innerHTML = day.storyPage2
          .split("\n")
          .map((p) => `<p>${p}</p>`)
          .join("");

        ELEMENTS.storyPage1.style.display =
          state.storyPage === 1 ? "block" : "none";
        ELEMENTS.storyPage2.style.display =
          state.storyPage === 2 ? "block" : "none";

        ELEMENTS.storyPrevBtn.disabled = state.storyPage === 1;
        ELEMENTS.storyNextBtn.disabled = state.storyPage === 2;

        ELEMENTS.storyPrevBtn.style.opacity =
          state.storyPage === 1 ? "0.5" : "1";
        ELEMENTS.storyNextBtn.style.opacity =
          state.storyPage === 2 ? "0.5" : "1";

        ELEMENTS.storyDot1.classList.toggle("active", state.storyPage === 1);
        ELEMENTS.storyDot2.classList.toggle("active", state.storyPage === 2);
      }

      // --- GEMINI API ---
      async function callGemini(userMessage, characterKey, context) {
        if (!state.apiKey) return "Nincs Gemini kulcs! ü•Ø";
        // API h√≠v√°s szimul√°ci√≥ a dem√≥hoz (itt lenne a fetch)
        return "Ez egy teszt v√°lasz a v√≠zil√≥t√≥l! ü¶õ";
      }

      function handleDayClick(day) {
        playSound("pop");
        const today = state.testMode ? 31 : new Date().getDate();
        const isAvailable = day.id <= today;

        if (isAvailable) {
          if (!state.unlockedDays.includes(day.id)) {
            const newUnlocked = [...state.unlockedDays, day.id];
            saveState("unlockedDays", newUnlocked);

            const initialMsgs = [];
            initialMsgs.push({ text: day.msgs[0], isMe: false });
            initialMsgs.push({
              text: day.storyImageText,
              isMe: false,
              isImageText: true,
            });
            initialMsgs.push({
              text: `<img src="${day.storyImageUrl}" alt="K√©p">`,
              isMe: false,
              isImage: true,
            });
            initialMsgs.push({ text: day.msgs[1], isMe: false });

            const newHist = {
              ...state.chatHistory,
              [day.id]: { msgs: initialMsgs, seen: false },
            };
            saveState("chatHistory", newHist);
            state.notifAfterCloseDayId = day.id;
          }

          ELEMENTS.storyTitle.textContent = "üìú " + day.title;
          setView("story", day.id);
        } else {
          addNotification("Rendszer", "M√©g nem szabad! ü§´", "üîí");
        }
      }

      async function sendMessage(text) {
        playSound("pop");
        const trimmedText = text.trim();
        if (!trimmedText || state.typing || !state.currentDayId) return;

        const dayId = state.currentDayId;
        const day = STORY_DATA.find((d) => d.id === dayId);
        if (!day) return;

        let currentHist = state.chatHistory[dayId] || { msgs: [] };
        const userMessage = { text: trimmedText, isMe: true };
        const msgsAfterUser = [...currentHist.msgs, userMessage];

        saveState("chatHistory", {
          ...state.chatHistory,
          [dayId]: { ...currentHist, msgs: msgsAfterUser, seen: true },
        });

        ELEMENTS.chatInput.value = "";
        ELEMENTS.chatSendCircle.classList.add("disabled");
        state.typing = true;
        renderChatDetail();

        await new Promise((r) => setTimeout(r, 1500));

        const context = `Mese: ... Aj√°nd√©k: ...`;
        const response = await callGemini(trimmedText, day.char, context);

        state.typing = false;
        playSound("ding");

        const finalMsgs = [...msgsAfterUser, { text: response, isMe: false }];
        const finalHist = {
          ...state.chatHistory,
          [dayId]: { msgs: finalMsgs, seen: true },
        };

        saveState("chatHistory", finalHist);
      }

      // --- RENDEREREK ---
      function createSnowflake() {
        const snowflakeEl = document.createElement("div");
        snowflakeEl.className = "snowflake";
        snowflakeEl.style.left = Math.random() * 100 + "%";
        snowflakeEl.style.animationDuration = Math.random() * 5 + 3 + "s";
        snowflakeEl.style.width = Math.random() * 4 + 2 + "px";
        snowflakeEl.style.height = Math.random() * 4 + 2 + "px";
        document.querySelector(".app-screen").appendChild(snowflakeEl);
        setTimeout(() => snowflakeEl.remove(), (Math.random() * 5 + 8) * 1000);
      }

      function updateCountdown() {
        const now = new Date();
        const xmas = new Date(now.getFullYear(), 11, 24);
        const diff = Math.ceil((xmas - now) / (1000 * 60 * 60 * 24));
        ELEMENTS.countdown.textContent =
          diff > 0 ? `M√©g ${diff} nap` : "Boldog Kar√°csonyt!";
      }

      function renderGrid() {
        ELEMENTS.gridContainer.innerHTML = "";
        const today = state.testMode ? 31 : new Date().getDate();

        STORY_DATA.forEach((day) => {
          const isOpen = state.unlockedDays.includes(day.id);
          const isLocked = day.id > today && !isOpen && !state.testMode;

          const cardEl = document.createElement("div");
          cardEl.className = `day-card ${isOpen ? "opened" : ""} ${
            isLocked ? "locked" : ""
          } clickable`;
          cardEl.onclick = () => handleDayClick(day);

          cardEl.innerHTML = isOpen
            ? `<div class="status-icon">‚úÖ</div>`
            : `<div class="day-num">${day.id}</div>`;

          if (isLocked)
            cardEl.innerHTML += `<div style="position:absolute; bottom:20px; font-size:20px;">üîí</div>`;

          ELEMENTS.gridContainer.appendChild(cardEl);
        });

        // AUTOMATIKUS G√ñRGET√âS A MAI NAPHOZ
        setTimeout(() => {
          const targetIndex = Math.min(today, 24) - 1;
          const cards = ELEMENTS.gridContainer.children;
          if (cards[targetIndex]) {
            cards[targetIndex].scrollIntoView({
              behavior: "smooth",
              inline: "center",
              block: "center",
            });
          }
        }, 100);
      }

      function renderChatList() {
        ELEMENTS.chatListBody.innerHTML = "";
        let totalUnread = 0;

        CHAT_CONTACTS.forEach((contact) => {
          const charDays = STORY_DATA.filter(
            (d) => d.char === contact.key && state.unlockedDays.includes(d.id)
          ).sort((a, b) => b.id - a.id);
          if (charDays.length === 0) return;

          let isUnread = false;
          let lastMsg = "Nincs √ºzenet";
          let latestDayId = charDays[0].id;

          const latestHist = state.chatHistory[latestDayId] || { msgs: [] };

          for (const day of charDays) {
            const hist = state.chatHistory[day.id] || { msgs: [] };
            if (!hist.seen) {
              isUnread = true;
              totalUnread++;
            }
          }

          if (latestHist.msgs.length > 0) {
            const last = latestHist.msgs[latestHist.msgs.length - 1];
            lastMsg = (last.isMe ? "√ân: " : "") + last.text;
          } else if (charDays[0].msgs.length > 0) {
            lastMsg = charDays[0].msgs[0];
          }

          const listItem = document.createElement("div");
          listItem.onclick = () => {
            playSound("pop");
            setView("chatDetail", latestDayId);
          };
          listItem.style.cssText =
            "display:flex; gap:15px; padding:15px; border-bottom:1px solid #222; cursor:pointer;";
          listItem.classList.add("clickable");

          listItem.innerHTML = `
                    <div style="font-size:30px;">${contact.icon}</div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between;"><span style="font-weight:bold; color:white;">${
                          contact.name
                        }</span><span style="color:#666; font-size:14px;">Ma</span></div>
                        <div style="color:${
                          isUnread ? "white" : "#888"
                        }; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:250px; font-weight:${
            isUnread ? "bold" : "normal"
          };">${lastMsg}</div>
                    </div>
                    ${
                      isUnread
                        ? '<div style="width:10px; height:10px; border-radius:50%; background:#007AFF; align-self:center;"></div>'
                        : ""
                    }
                `;
          ELEMENTS.chatListBody.appendChild(listItem);
        });

        ELEMENTS.unreadBadge.textContent = totalUnread;
        ELEMENTS.unreadBadge.style.display = totalUnread > 0 ? "flex" : "none";
      }

      function renderChatDetail() {
        const dayId = state.currentDayId;
        if (!dayId) return;
        const selectedDay = STORY_DATA.find((d) => d.id === dayId);
        const char = CHARACTERS[selectedDay.char];
        const allCharDays = STORY_DATA.filter(
          (d) =>
            d.char === selectedDay.char && state.unlockedDays.includes(d.id)
        ).sort((a, b) => a.id - b.id);

        let allMessages = [];
        let shouldMarkAsSeen = false;

        for (const day of allCharDays) {
          const hist = state.chatHistory[day.id] || { msgs: [] };
          allMessages.push({ text: `iMessage ‚Ä¢ ${day.title}`, isSystem: true });
          allMessages = allMessages.concat(hist.msgs);
          if (!hist.seen) {
            shouldMarkAsSeen = true;
            state.chatHistory[day.id] = { ...hist, seen: true };
          }
        }

        ELEMENTS.chatDetailIcon.textContent = char.icon;
        ELEMENTS.chatDetailName.textContent = char.name;
        ELEMENTS.chatDetailBody.innerHTML = "";

        allMessages.forEach((msg) => {
          if (msg.isSystem) {
            ELEMENTS.chatDetailBody.innerHTML += `<div style="text-align:center; color:#666; font-size:11px; margin:10px 0;">${msg.text}</div>`;
            return;
          }
          const msgRow = document.createElement("div");
          msgRow.className = `message-row ${msg.isMe ? "me" : "them"}`;
          const avatarHtml = !msg.isMe
            ? `<div class="avatar-small">${char.icon}</div>`
            : "";
          let bubbleClass = "bubble";
          if (msg.isImage) bubbleClass += " image-bubble";
          const contentHtml = msg.isImage ? msg.text : msg.text;
          const bubbleHtml = `<div class="bubble ${msg.isMe ? "me" : "them"} ${
            msg.isImage ? "image-bubble" : ""
          }">${contentHtml}</div>`;
          msgRow.innerHTML = msg.isMe ? bubbleHtml : avatarHtml + bubbleHtml;
          ELEMENTS.chatDetailBody.appendChild(msgRow);
        });

        // Typing
        const typingEl = ELEMENTS.chatDetailBody.querySelector(
          ".typing-indicator-row"
        );
        if (state.typing && !typingEl) {
          const typingRow = document.createElement("div");
          typingRow.className = "message-row them typing-indicator-row";
          typingRow.innerHTML = `<div class="avatar-small">${char.icon}</div><div class="typing-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
          ELEMENTS.chatDetailBody.appendChild(typingRow);
        } else if (!state.typing && typingEl) {
          typingEl.remove();
        }

        ELEMENTS.chatDetailBody.scrollTop =
          ELEMENTS.chatDetailBody.scrollHeight;

        // Reply Chips logic (simplified)
        const latestHist = state.chatHistory[selectedDay.id] || { msgs: [] };
        if (
          !latestHist.msgs.some((m) => m.isMe) &&
          selectedDay.replies.length > 0
        ) {
          ELEMENTS.replyChips.style.display = "flex";
          ELEMENTS.replyChips.innerHTML = "";
          selectedDay.replies.forEach((reply) => {
            const chip = document.createElement("div");
            chip.className = "chip clickable";
            chip.textContent = reply.u;
            chip.onclick = () => sendMessage(reply.u);
            ELEMENTS.replyChips.appendChild(chip);
          });
        } else {
          ELEMENTS.replyChips.style.display = "none";
        }

        if (shouldMarkAsSeen) saveState("chatHistory", state.chatHistory);
      }

      function renderApp() {
        ELEMENTS.apiModal.style.display = state.apiKey ? "none" : "flex";
        if (!state.apiKey) return;

        ELEMENTS.gridView.style.display =
          state.view === "grid" ? "flex" : "none";
        ELEMENTS.storyModal.classList.toggle("active", state.view === "story");
        ELEMENTS.tabGrid.classList.toggle("active", state.view === "grid");
        ELEMENTS.tabChat.classList.toggle(
          "active",
          state.view === "chatList" || state.view === "chatDetail"
        );
        ELEMENTS.chatScreenList.classList.toggle(
          "active",
          state.view === "chatList" || state.view === "chatDetail"
        );
        ELEMENTS.chatScreenDetail.classList.toggle(
          "active",
          state.view === "chatDetail"
        );

        if (state.view === "grid") {
          renderGrid();
          renderChatList();
        } else if (state.view === "story") {
          updateStoryModalPages();
        } else if (state.view === "chatList") {
          renderChatList();
        } else if (state.view === "chatDetail") {
          renderChatList();
          renderChatDetail();
        }

        const hasText = ELEMENTS.chatInput.value.trim().length > 0;
        ELEMENTS.chatSendCircle.classList.toggle(
          "disabled",
          !hasText || state.typing
        );
      }

      // --- INIT ---
      for (let i = 0; i < 40; i++) createSnowflake();
      setInterval(updateCountdown, 1000);

      ELEMENTS.apiSaveBtn.onclick = () => {
        playSound("pop");
        if (ELEMENTS.apiInput.value.trim().length > 10) {
          saveState("apiKey", ELEMENTS.apiInput.value.trim());
          ELEMENTS.apiModal.style.display = "none";
          renderApp();
        } else alert("Hib√°s kulcs!");
      };
      ELEMENTS.tabGrid.onclick = () => {
        playSound("pop");
        setView("grid");
      };
      ELEMENTS.tabChat.onclick = () => {
        playSound("pop");
        setView("chatList");
      };
      ELEMENTS.storyCloseBtn.onclick = () => {
        playSound("pop");
        setView("grid");
      };
      ELEMENTS.storyPrevBtn.onclick = () => {
        if (state.storyPage > 1) {
          state.storyPage--;
          renderApp();
        }
      };
      ELEMENTS.storyNextBtn.onclick = () => {
        if (state.storyPage < 2) {
          state.storyPage++;
          renderApp();
        }
      };
      document.getElementById("chat-list-close-btn").onclick = () => {
        playSound("pop");
        setView("grid");
      };
      document.getElementById("chat-detail-back-btn").onclick = () => {
        playSound("pop");
        setView("chatList", state.currentDayId);
      };

      ELEMENTS.chatInput.oninput = () => {
        ELEMENTS.chatSendCircle.classList.toggle(
          "disabled",
          !ELEMENTS.chatInput.value.trim() || state.typing
        );
      };
      ELEMENTS.chatSendCircle.onclick = () =>
        sendMessage(ELEMENTS.chatInput.value);

      ELEMENTS.testBtn.onclick = () => {
        state.testMode = !state.testMode;
        addNotification(
          "Rendszer",
          `Teszt M√≥d: ${state.testMode ? "BE" : "KI"}`,
          "‚öôÔ∏è"
        );
        renderApp();
      };

      window.onload = renderApp;
    </script>
  </body>
</html>
